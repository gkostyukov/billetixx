// ============================================================
// Prisma Schema — Billetixx Forex Trading Platform
// ============================================================
// Models:
//   User          — authenticated trader account
//   Account       — NextAuth OAuth account links
//   Session       — NextAuth sessions
//   VerificationToken — NextAuth email verification
//   TradeSignal   — AI-generated trade decision tickets
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Authenticated user / trader account.
/// Stores per-user OANDA and OpenAI credentials.
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // OANDA API credentials (per-user)
  oandaEnvironment       String   @default("practice") // "practice" or "live"
  oandaPracticeAccountId String?
  oandaPracticeToken     String?
  oandaLiveAccountId     String?
  oandaLiveToken         String?

  // OpenAI API key (per-user, optional — falls back to server .env)
  openaiApiKey           String?

  tradeSignals      TradeSignal[]
  signalOrderLinks  SignalOrderLink[]
  accounts          Account[]
  sessions          Session[]
}

/// NextAuth — OAuth provider account links.
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

/// NextAuth — active user sessions.
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// NextAuth — email verification tokens.
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/// AI-generated trade decision ticket.
/// Created when the user requests an AI analysis on the Trading terminal.
model TradeSignal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  instrument  String   // e.g. "EUR_USD"
  timeframe   String   @default("M15")
  action      String   // "BUY" | "SELL" | "WAIT"
  entryPrice  Float?
  stopLoss    Float?
  takeProfit  Float?
  rationale   String   // Full AI reasoning text
  status      String   @default("open") // "open" | "closed" | "cancelled"

  orderLinks  SignalOrderLink[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

/// Link between an AI TradeSignal (analytics ticket) and actual OANDA order/trade lifecycle.
model SignalOrderLink {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  signalId     String
  signal       TradeSignal @relation(fields: [signalId], references: [id], onDelete: Cascade)

  instrument   String
  side         String?  // BUY | SELL
  orderType    String?  // MARKET | LIMIT | STOP

  oandaOrderId String?
  oandaTradeId String?

  status       String   @default("created") // created | filled | cancelled | rejected
  detailsJson  String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId, signalId])
  @@index([userId, oandaOrderId])
  @@index([userId, oandaTradeId])
}

/// Cached sentiment/impact snapshot based on recent market news headlines.
/// Used to avoid recalculating news impact on each terminal refresh.
model NewsImpactSnapshot {
  id                 String   @id @default(cuid())
  instrument         String
  timeframe          String   @default("M15")
  upsideProbability  Int
  downsideProbability Int
  reversalRisk       Int
  marketBias         String
  summary            String
  headlinesJson      String
  generatedAt        DateTime @default(now())
  expiresAt          DateTime
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([instrument, timeframe, expiresAt])
}
